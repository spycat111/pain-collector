<!DOCTYPE html>
<html>
<head>
  <title>Pain Data Collection</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@latest/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@latest/camera_utils.js"></script>
</head>
<body>
  <h1>Rate Your Pain</h1>
  <video id="video" autoplay muted playsinline width="640" height="480"></video>
  <div>
    <label for="rating">Pain (0â€“10):</label>
    <input type="number" id="rating" min="0" max="10" value="0">
    <button id="submit">Submit</button>
  </div>
  <script>
    const video = document.getElementById('video');
    const ratingInput = document.getElementById('rating');
    const submitBtn  = document.getElementById('submit');

    // 1) Initialize MediaPipe FaceMesh
    const faceMesh = new FaceMesh({locateFile: f => 
      `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@latest/${f}`});
    faceMesh.setOptions({maxNumFaces: 1, minDetectionConfidence: 0.5});
    faceMesh.onResults(onResults);

    const camera = new Camera(video, {
      onFrame: async () => await faceMesh.send({image: video}),
      width: 640, height: 480
    });
    camera.start();

    let lastFeatures = null;
    function onResults(results) {
      if (results.multiFaceLandmarks && results.multiFaceLandmarks.length) {
        const landmarks = results.multiFaceLandmarks[0];
        // flatten normalized coords into an array
        lastFeatures = landmarks.map(lm => [lm.x, lm.y, lm.z]).flat();
      }
    }

    // 2) Submit handler
    submitBtn.addEventListener('click', () => {
      if (!lastFeatures) return alert("No face detected yet.");
      const payload = {
        features: lastFeatures,
        rating: Number(ratingInput.value),
        timestamp: new Date().toISOString()
      };
      fetch('/submit', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      }).then(r => {
        if (r.ok) alert("Thank you! Data submitted.");
        else alert("Submission failed.");
      });
    });
  </script>
</body>
</html>
